@inject HttpClient Http
@using FeedbackSystem.Contracts.DTO
@using System.ComponentModel.DataAnnotations

<EditForm Model="feedback" OnValidSubmit="ShowModal">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Name</label>
        <InputText class="form-control" @bind-Value="feedback.UserName" />
        <ValidationMessage For="@(() => feedback.UserName)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Feedback</label>
        <InputTextArea class="form-control" rows="3" @bind-Value="feedback.FeedbackText" />
        <ValidationMessage For="@(() => feedback.FeedbackText)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Rating</label>
        <InputNumber class="form-control" min="1" max="5"@bind-Value="feedback.Rating" />
        <ValidationMessage For="@(() => feedback.Rating)" />
    </div>

    <button class="btn btn-primary" type="submit" disabled="@isSubmitting">
        Submit
    </button>
</EditForm>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@if (askConfirmation)
{
    <div class="modal fade show d-block" >
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Confirm Feedback</h5>
                    <button class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <p><strong>Name:</strong> @feedback.UserName</p>
                    <p><strong>Feedback:</strong> @feedback.FeedbackText</p>
                    <p><strong>Rating:</strong> @feedback.Rating</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary"
                            @onclick="CloseModal"
                            disabled="@isSubmitting">
                        Cancel
                    </button>

                    <button class="btn btn-success"
                            @onclick="ConfirmSubmit"
                            disabled="@isSubmitting">
                        Confirm
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@code {

    private bool askConfirmation = false;
    private bool isSubmitting = false;
    private string message = string.Empty;

    private FeedbackDTO feedback = new()
    {
        UserName = string.Empty,
        FeedbackText = string.Empty,
        Rating = 0
    };

    private void ShowModal()
    {
        askConfirmation = true;
    }

    private void CloseModal()
    {
        askConfirmation = false;
    }

    private async Task ConfirmSubmit()
    {
        isSubmitting = true;

        try
        {
            var response = await Http.PostAsJsonAsync("api/feedback", feedback);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                message = $"API Error ({response.StatusCode}): {error}";
                return;
            }

            message = "Feedback submitted successfully!";

            feedback = new FeedbackDTO
            {
                UserName = string.Empty,
                FeedbackText = string.Empty,
                Rating = 1
            };
        }
        catch (HttpRequestException ex)
        {
            message = $"Network error: {ex.Message}";
        }
        catch (Exception ex)
        {
            message = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            askConfirmation = false;
        }
    }
}
